<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= site.meta.name %> | <%= site.meta.title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <div class="loading-screen" data-loading-screen>
      <div class="loading-panel">
        <div class="loading-title">LOADING MAMORU PORTFOLIO</div>
        <div class="candles" aria-hidden="true">
          <% for (let i = 0; i < 26; i += 1) { %>
            <span class="candle"></span>
          <% } %>
        </div>
      </div>
    </div>
    <div class="grain"></div>
    <header class="topbar">
      <div class="logo">
        <span class="logo-mark">▲</span>
        <span><%= site.meta.name %></span>
      </div>
      <nav class="topnav">
        <% (site.navigation || []).forEach((item) => { %>
          <button class="nav-link" data-target="<%= item.target %>"><%= item.label %></button>
        <% }) %>
      </nav>
      <div class="status">
        <span class="dot"></span>
        <span><%= site.status.label %></span>
      </div>
    </header>

    <%
      const projectItems = (projects.items || []);
      const normalizedProjects = projectItems.map((project) => {
        const fallbackDate = `${project.year || "2024"}-01-01`;
        const parsedDate = Date.parse(project.date || fallbackDate);
        const dateValue = Number.isNaN(parsedDate) ? Date.parse(fallbackDate) : parsedDate;
        return { ...project, date: project.date || fallbackDate, dateValue };
      });
      const sortedProjects = normalizedProjects.slice().sort((a, b) => a.dateValue - b.dateValue);
      const yearBuckets = [];
      const yearMap = new Map();
      sortedProjects.forEach((project) => {
        const yearKey = project.year || "Unknown";
        if (!yearMap.has(yearKey)) {
          const yearGroup = { year: yearKey, items: [] };
          yearMap.set(yearKey, yearGroup);
          yearBuckets.push(yearGroup);
        }
        yearMap.get(yearKey).items.push(project);
      });
      const tagSet = new Set();
      sortedProjects.forEach((project) => {
        (project.tags || []).forEach((tag) => tagSet.add(tag));
      });
      const tagList = Array.from(tagSet);
    %>

    <main class="ticker-wrapper">
      <div class="ticker">
        <% const ticker = site.ui && site.ui.ticker ? site.ui.ticker : { items: [], repeat: 1 }; %>
        <% const tickerItems = ticker.items || []; %>
        <% const tickerRepeat = Math.max(1, ticker.repeat || 1); %>
        <% for (let i = 0; i < tickerRepeat; i += 1) { %>
          <div class="ticker-line">
            <% tickerItems.forEach((item) => { %>
              <span class="<%= item.tone === 'gain' ? 'gain' : '' %>"><%= item.text %></span>
            <% }) %>
          </div>
        <% } %>
      </div>
    </main>

    <div class="scroll-hint"><%= site.ui.scrollHint %></div>

    <section class="panels" id="panels">
      <article class="panel intro" data-panel="intro">
        <div class="panel-header">
          <h2><%= site.sections.profile.title %></h2>
          <p><%= site.sections.profile.subtitle %></p>
        </div>
        <div class="intro-card">
          <div class="intro-photo">
            <% if (site.intro.photo) { %>
              <img src="<%= site.intro.photo %>" alt="<%= site.meta.name %> profile" />
            <% } else { %>
              <div class="photo-placeholder">No Image</div>
            <% } %>
          </div>
          <div class="intro-info">
            <div>
              <p class="label">Name</p>
              <p class="value"><%= site.meta.name %></p>
            </div>
            <div>
              <p class="label">Age</p>
              <p class="value"><%= site.intro.age %></p>
            </div>
            <div>
              <p class="label">Affiliation</p>
              <p class="value"><%= site.intro.affiliation %></p>
            </div>
            <div class="intro-message">
              <p class="label">One Line</p>
              <p class="value"><%= site.intro.headline %></p>
            </div>
            <% if (site.intro.skills && site.intro.skills.length) { %>
              <div class="intro-message">
                <p class="label">得意スキル</p>
                <p class="value"><%= site.intro.skills.join(" / ") %></p>
              </div>
            <% } %>
            <% if (site.intro.valueProposition) { %>
              <div class="intro-message">
                <p class="label">提供価値</p>
                <p class="value"><%= site.intro.valueProposition %></p>
              </div>
            <% } %>
            <div class="intro-links">
              <p class="label">Social Links</p>
              <div class="link-list">
                <% site.intro.links.forEach((link) => { %>
                  <a href="<%= link.url %>" target="_blank" rel="noopener">
                    <%= link.label %> ↗
                  </a>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      </article>

      <article class="panel timeline-panel" data-panel="timeline">
        <div class="panel-header">
          <h2><%= site.sections.timeline.title %></h2>
          <p><%= site.sections.timeline.subtitle %></p>
        </div>
        <div class="timeline-board" data-timeline-board>
          <div class="timeline-track" data-timeline-track>
            <svg class="timeline-line" aria-hidden="true">
              <polyline class="timeline-polyline" fill="none"></polyline>
            </svg>
            <div class="timeline-list">
            <% yearBuckets.forEach((bucket) => { %>
              <div class="timeline-item">
                <div class="timeline-marker">
                  <span class="timeline-dot" aria-hidden="true"></span>
                  <span class="timeline-year"><%= bucket.year %></span>
                </div>
                <div class="timeline-cards timeline-cards--compact">
                  <% bucket.items.forEach((project) => { %>
                    <div
                      class="timeline-card timeline-card--compact"
                      role="button"
                      tabindex="0"
                      data-activity-id="<%= project.id %>"
                    >
                      <div class="timeline-card-head">
                        <h3><%= project.name %></h3>
                        <span class="timeline-market"><%= project.market || project.sector %></span>
                      </div>
                    </div>
                  <% }) %>
                  <a class="chart-link" href="#process" data-year="<%= bucket.year %>">この年のプロジェクトを見る →</a>
                </div>
              </div>
            <% }) %>
            </div>
          </div>
        </div>
        <div class="timeline-scrollbar" data-timeline-scrollbar aria-hidden="true">
          <div class="timeline-scrollbar-track">
            <div class="timeline-scrollbar-thumb"></div>
          </div>
        </div>
      </article>

      <article class="panel process" data-panel="process">
        <div class="panel-header">
          <h2><%= site.sections.activities.title %></h2>
          <p><%= site.sections.activities.subtitle %></p>
        </div>
        <div class="process-filters">
          <div class="filter-row">
            <button class="filter-button is-active" type="button" data-filter-tag="all">All</button>
            <% tagList.forEach((tag) => { %>
              <button class="filter-button" type="button" data-filter-tag="<%= tag %>">#<%= tag %></button>
            <% }) %>
          </div>
          <div class="filter-meta">
            <span class="filter-status" data-filter-status></span>
            <button class="filter-reset" type="button" data-filter-reset>Reset</button>
          </div>
        </div>
        <div class="project-list">
          <% sortedProjects.forEach((project) => { %>
            <%
              const projectCover = project.cover || site.intro.photo || "assets/mamorudesu.jpeg";
              const hasText = (value) => value && value !== "TBD";
              const techList = (project.tech || []).filter(Boolean);
              const tagList = (project.tags || []).filter(Boolean);
              const metaItems = [
                { label: "担当範囲", value: project.responsibilities },
                { label: "役割", value: project.role },
                { label: "使用技術", value: techList.length ? techList.join(" / ") : "" },
                { label: "期間", value: project.period },
                { label: "チーム規模", value: project.teamSize }
              ].filter((item) => hasText(item.value));
            %>
            <article
              class="project-card"
              data-project-card
              data-year="<%= project.year %>"
              data-tags="<%= (project.tags || []).join(",") %>"
              data-project-id="<%= project.id %>"
            >
              <div class="project-media">
                <img src="<%= projectCover %>" alt="<%= project.name %> project preview" loading="lazy" />
              </div>
              <div class="project-body">
                <div class="project-head">
                  <span class="project-year"><%= project.year %></span>
                </div>
                <h3 class="project-title"><%= project.name %></h3>
                <% if (hasText(project.sector) || hasText(project.market)) { %>
                  <p class="project-sector"><span class="meta-label">領域</span><%= project.market || project.sector %></p>
                <% } %>
                <% if (hasText(project.thesis)) { %>
                  <p class="project-thesis"><span class="meta-label">概要</span><%= project.thesis %></p>
                <% } %>
                <% if (hasText(project.result)) { %>
                  <p class="project-result"><span class="meta-label">成果</span><%= project.result %></p>
                <% } %>
                <% if (metaItems.length) { %>
                  <div class="project-meta">
                    <% metaItems.forEach((item) => { %>
                      <div class="meta-item">
                        <span class="meta-key"><%= item.label %></span>
                        <span class="meta-value"><%= item.value %></span>
                      </div>
                    <% }) %>
                  </div>
                <% } %>
                <% if (tagList.length) { %>
                  <div class="project-tags">
                    <% tagList.forEach((tag) => { %>
                      <span>#<%= tag %></span>
                    <% }) %>
                  </div>
                <% } %>
              </div>
            </article>
          <% }) %>
        </div>
      </article>

      <article class="panel contact" data-panel="contact" id="contact">
        <div class="panel-header">
          <h2><%= site.sections.contact.title %></h2>
          <p class="contact-lead"><%= site.sections.contact.lead %></p>
          <p class="contact-sublead"><%= site.sections.contact.sublead %></p>
          <p class="contact-note">
            <%= site.sections.contact.note.prefix %>
            <a class="link" href="mailto:<%= site.contact.email %>?subject=<%= encodeURIComponent(site.contact.mailSubject) %>">
              <%= site.sections.contact.note.linkLabel %>
            </a><%= site.sections.contact.note.suffix %>
          </p>
        </div>
        <div class="contact-card">
          <% const form = site.contact.form || {}; %>
          <form
            class="contact-form"
            action="<%= form.action || ('mailto:' + site.contact.email) %>"
            method="<%= form.method || 'post' %>"
          >
            <% const formFields = form.fields || {}; %>
            <% (form.rows || []).forEach((row) => { %>
              <div class="form-row">
                <% row.forEach((fieldKey) => { %>
                  <% const field = formFields[fieldKey]; %>
                  <% if (!field) return; %>
                  <div class="form-field">
                    <label class="form-label" for="contact-<%= fieldKey %>">
                      <%= field.label %>
                      <% if (field.required) { %>
                        <span class="required">*</span>
                      <% } %>
                    </label>
                    <% if (field.type === "textarea") { %>
                      <textarea
                        class="form-textarea"
                        id="contact-<%= fieldKey %>"
                        name="<%= field.name %>"
                        rows="<%= field.rows || 6 %>"
                        <% if (field.required) { %>required<% } %>
                        <% if (field.maxlength) { %>maxlength="<%= field.maxlength %>"<% } %>
                        placeholder="<%= field.placeholder || '' %>"
                      ></textarea>
                    <% } else { %>
                      <input
                        class="form-input"
                        id="contact-<%= fieldKey %>"
                        name="<%= field.name %>"
                        type="<%= field.type || "text" %>"
                        <% if (field.autocomplete) { %>autocomplete="<%= field.autocomplete %>"<% } %>
                        <% if (field.required) { %>required<% } %>
                        <% if (field.maxlength) { %>maxlength="<%= field.maxlength %>"<% } %>
                        placeholder="<%= field.placeholder || '' %>"
                      />
                    <% } %>
                  </div>
                <% }) %>
              </div>
            <% }) %>

            <label class="form-checkbox">
              <input id="contact-policy" type="checkbox" name="policy" required />
              <span>
                <a class="link" href="<%= form.privacyUrl %>"><%= form.privacyLabel %></a>
              </span>
            </label>

            <p class="form-hint">
              <%= form.hint %>
            </p>

            <div class="form-actions">
              <button class="cta" type="submit"><%= form.submitLabel %></button>
              <a class="link" href="mailto:<%= site.contact.email %>?subject=<%= encodeURIComponent(site.contact.mailSubject) %>">
                <%= form.directEmailLabel %>
              </a>
            </div>
          </form>
        </div>
      </article>
    </section>

    <script src="assets/main.js"></script>
    <% if (dev) { %>
      <script>
        if ("EventSource" in window) {
          const source = new EventSource("/__reload");
          source.addEventListener("message", () => {
            window.location.reload();
          });
        }
      </script>
    <% } %>
  </body>
</html>
