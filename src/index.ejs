<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= site.name %> | <%= site.title %></title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <div class="grain"></div>
    <header class="topbar">
      <div class="logo">
        <span class="logo-mark">▲</span>
        <span><%= site.name %></span>
      </div>
      <nav class="topnav">
        <button class="nav-link" data-target="intro">Profile</button>
        <button class="nav-link" data-target="timeline">Timeline</button>
        <button class="nav-link" data-target="process">Process</button>
        <button class="nav-link" data-target="contact">Contact</button>
      </nav>
      <div class="status">
        <span class="dot"></span>
        <span><%= site.marketStatus %></span>
      </div>
    </header>

    <%
      const normalizedProjects = projects.map((project) => {
        const fallbackDate = `${project.year || "2024"}-01-01`;
        const parsedDate = Date.parse(project.date || fallbackDate);
        const dateValue = Number.isNaN(parsedDate) ? Date.parse(fallbackDate) : parsedDate;
        const height = Number(project.height ?? 0);
        return { ...project, date: project.date || fallbackDate, dateValue, height };
      });
      const sortedProjects = normalizedProjects.slice().sort((a, b) => a.dateValue - b.dateValue);
      const dateValues = sortedProjects.map((project) => project.dateValue);
      const heightValues = sortedProjects.map((project) => project.height);
      const minDate = Math.min(...dateValues);
      const maxDate = Math.max(...dateValues);
      const minHeight = Math.min(...heightValues);
      const maxHeight = Math.max(...heightValues);
      const dateRange = Math.max(1, maxDate - minDate);
      const heightRange = Math.max(1, maxHeight - minHeight);
      const timelinePadding = 12;
      const timelinePoints = sortedProjects.map((project) => {
        const x = timelinePadding + ((project.dateValue - minDate) / dateRange) * (100 - timelinePadding * 2);
        const y = timelinePadding + ((maxHeight - project.height) / heightRange) * (100 - timelinePadding * 2);
        return { ...project, x, y };
      });
      const timelineLinePoints = timelinePoints.map((point) => `${point.x.toFixed(2)},${point.y.toFixed(2)}`).join(" ");
    %>

    <main class="ticker-wrapper">
      <div class="ticker">
        <div class="ticker-line">
          <span>NASDAQ / Portfolio Index</span>
          <span class="gain">+2.4%</span>
          <span>YTD: +18.7%</span>
          <span class="gain">ROI +141%</span>
          <span>Volatility: 0.62</span>
          <span class="gain">Momentum: High</span>
        </div>
        <div class="ticker-line">
          <span>NASDAQ / Portfolio Index</span>
          <span class="gain">+2.4%</span>
          <span>YTD: +18.7%</span>
          <span class="gain">ROI +141%</span>
          <span>Volatility: 0.62</span>
          <span class="gain">Momentum: High</span>
        </div>
      </div>
    </main>

    <div class="scroll-hint">Scroll →</div>

    <section class="panels" id="panels">
      <article class="panel intro" data-panel="intro">
        <div class="panel-header">
          <h2>Profile Sheet</h2>
          <p>自己紹介とSNSリンクをまとめています。</p>
        </div>
        <div class="intro-card">
          <div class="intro-photo">
            <% if (site.intro.photo) { %>
              <img src="<%= site.intro.photo %>" alt="<%= site.name %> profile" />
            <% } else { %>
              <div class="photo-placeholder">No Image</div>
            <% } %>
          </div>
          <div class="intro-info">
            <div>
              <p class="label">Name</p>
              <p class="value"><%= site.name %></p>
            </div>
            <div>
              <p class="label">Age</p>
              <p class="value"><%= site.intro.age %></p>
            </div>
            <div>
              <p class="label">Affiliation</p>
              <p class="value"><%= site.intro.affiliation %></p>
            </div>
            <div class="intro-message">
              <p class="label">One Line</p>
              <p class="value"><%= site.intro.headline %></p>
            </div>
            <% if (site.intro.skills && site.intro.skills.length) { %>
              <div class="intro-message">
                <p class="label">得意スキル</p>
                <p class="value"><%= site.intro.skills.join(" / ") %></p>
              </div>
            <% } %>
            <% if (site.intro.valueProposition) { %>
              <div class="intro-message">
                <p class="label">提供価値</p>
                <p class="value"><%= site.intro.valueProposition %></p>
              </div>
            <% } %>
            <div class="intro-links">
              <p class="label">Social Links</p>
              <div class="link-list">
                <% site.intro.links.forEach((link) => { %>
                  <a href="<%= link.url %>" target="_blank" rel="noopener">
                    <%= link.label %> ↗
                  </a>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      </article>

      <article class="panel timeline-panel" data-panel="timeline">
        <div class="panel-header">
          <h2>Timeline Chart</h2>
          <p>プロジェクトの推移を年表で確認できます。</p>
        </div>
        <div class="timeline-chart">
          <div class="life-chart life-chart--timeline">
            <div class="life-chart-inner">
              <svg class="life-chart-svg" viewBox="0 0 100 100" aria-hidden="true" preserveAspectRatio="none">
                <polyline class="chart-line" points="<%= timelineLinePoints %>" fill="none" />
              </svg>
              <% timelinePoints.forEach((point) => { %>
                <span
                  class="chart-dot chart-dot--timeline"
                  style="--x: <%= point.x.toFixed(2) %>; --y: <%= point.y.toFixed(2) %>;"
                ></span>
              <% }) %>
              <% timelinePoints.forEach((point) => { %>
                <button
                  class="chart-point <%= point.y < 18 ? "is-top" : "" %>"
                  type="button"
                  data-url="<%= point.url %>"
                  style="--x: <%= point.x.toFixed(2) %>; --y: <%= point.y.toFixed(2) %>;"
                >
                    <div class="chart-card">
                      <span class="chart-date"><%= point.date %></span>
                      <h4><%= point.name %></h4>
                    <div class="chart-skills">
                      <% (point.skills || []).forEach((skill) => { %>
                        <div class="chart-skill">
                          <span class="skill-name"><%= skill %></span>
                          <span class="skill-gain"><%= point.skillGains && point.skillGains[skill] ? point.skillGains[skill] : "" %></span>
                        </div>
                      <% }) %>
                    </div>
                    <span class="chart-result"><%= point.result %></span>
                    <a class="chart-link" href="<%= point.url %>" target="_blank" rel="noopener">View More →</a>
                  </div>
                </button>
              <% }) %>
            </div>
          </div>
        </div>
      </article>

      <article class="panel process" data-panel="process">
        <div class="panel-header">
          <h2>Process: Market Thesis</h2>
          <p><%= site.about %></p>
        </div>
        <div class="process-grid">
          <div class="process-card">
            <h3>Research</h3>
            <p>市場の歪みを探し、ユーザー行動と数字を照合します。</p>
          </div>
          <div class="process-card">
            <h3>Strategy</h3>
            <p>投資仮説のように、打ち手とリスクを明確にします。</p>
          </div>
          <div class="process-card">
            <h3>Execution</h3>
            <p>プロトタイプを高速に検証し、勝ち筋を深掘りします。</p>
          </div>
          <div class="process-card">
            <h3>Growth</h3>
            <p>KPIに合わせて改善し、継続的な成長を実装します。</p>
          </div>
        </div>
        <div class="timeline">
          <% timeline.forEach((node) => { %>
            <div class="timeline-node">
              <span class="year"><%= node.year %></span>
              <span class="label"><%= node.label %></span>
              <% if (node.role) { %>
                <span class="timeline-role"><%= node.role %></span>
              <% } %>
              <% if (node.summary) { %>
                <span class="timeline-summary"><%= node.summary %></span>
              <% } %>
            </div>
          <% }) %>
        </div>
      </article>

      <article class="panel contact" data-panel="contact">
        <div class="panel-header">
          <h2>Investor Relations</h2>
          <p>For collaborations, speaking, or new ventures.</p>
        </div>
        <div class="contact-card">
          <div>
            <p class="label">Email</p>
            <p class="value">hello@example.com</p>
          </div>
          <div>
            <p class="label">Location</p>
            <p class="value">Tokyo / Remote</p>
          </div>
          <div>
            <p class="label">Availability</p>
            <p class="value">Q3 2025</p>
          </div>
          <button class="cta ghost">Download Resume →</button>
        </div>
      </article>
    </section>

    <script src="assets/main.js"></script>
    <% if (dev) { %>
      <script>
        if ("EventSource" in window) {
          const source = new EventSource("/__reload");
          source.addEventListener("message", () => {
            window.location.reload();
          });
        }
      </script>
    <% } %>
  </body>
</html>
